# Configuración de Autenticación de Google con Supabase

## Resumen de Cambios

La aplicación ahora usa el sistema de autenticación OAuth de Supabase para Google, eliminando la dependencia de la librería externa de Google Sign-In.

## Ventajas de usar Supabase OAuth

1. **Gestión centralizada**: Todas las sesiones se gestionan a través de Supabase
2. **Seguridad mejorada**: Las políticas RLS (Row Level Security) funcionan automáticamente
3. **Tokens actualizados**: Supabase gestiona automáticamente la renovación de tokens
4. **Menos dependencias**: No necesita el script externo de Google
5. **Experiencia consistente**: Mismo flujo para diferentes proveedores OAuth

## Configuración Requerida en Supabase

### 1. Configurar Google OAuth en Supabase Dashboard

1. Ve a tu proyecto en [Supabase Dashboard](https://app.supabase.com)
2. Navega a **Authentication** > **Providers**
3. Busca **Google** en la lista de proveedores
4. Activa el toggle para habilitar Google OAuth
5. Necesitarás configurar las credenciales de Google Cloud Console

### 2. Configurar Google Cloud Console

1. Ve a [Google Cloud Console](https://console.cloud.google.com)
2. Crea un nuevo proyecto o selecciona uno existente
3. Ve a **APIs & Services** > **Credentials**
4. Haz clic en **Create Credentials** > **OAuth 2.0 Client ID**
5. Configura la pantalla de consentimiento si es necesario:
   - Tipo de usuario: Externo
   - Información de la aplicación: Nombre, email de soporte
   - Ámbitos: email, profile, openid
6. Crea las credenciales OAuth:
   - Tipo de aplicación: **Web application**
   - Nombre: Tu aplicación
   - **URIs de redireccionamiento autorizados**: Copia la URL de callback de Supabase
     - Formato: `https://TU_PROYECTO.supabase.co/auth/v1/callback`
     - Ejemplo: `https://fmbhylezrqoaczqqiqwd.supabase.co/auth/v1/callback`

### 3. Copiar las credenciales a Supabase

1. Copia el **Client ID** de Google Cloud Console
2. Copia el **Client Secret** de Google Cloud Console
3. Pégalos en los campos correspondientes en Supabase Dashboard (Authentication > Providers > Google)
4. Guarda los cambios

### 4. Configurar la URL de redirección en la aplicación

La aplicación está configurada para redirigir a `/auth/callback` después de la autenticación.
Asegúrate de que esta URL coincida con tu configuración:

```typescript
// En auth.service.ts
redirectTo: `${window.location.origin}/auth/callback`
```

Para desarrollo local: `http://localhost:4200/auth/callback`
Para producción: `https://tu-dominio.com/auth/callback`

### 5. Agregar URLs permitidas en Supabase

1. En Supabase Dashboard, ve a **Authentication** > **URL Configuration**
2. Agrega tus URLs en **Site URL** y **Redirect URLs**:
   - Desarrollo: `http://localhost:4200`
   - Producción: `https://tu-dominio.com`

## Flujo de Autenticación

1. Usuario hace clic en "Continuar con Google"
2. La aplicación llama a `signInWithGoogle()` en AuthService
3. Supabase redirige al usuario a Google para autenticarse
4. Google redirige de vuelta a `/auth/callback` con el código de autorización
5. El componente `AuthCallbackComponent` procesa el callback
6. AuthService obtiene la sesión de Supabase y crea el usuario
7. Se carga el empleado asociado desde la base de datos
8. Usuario es redirigido a la página principal

## Archivos Modificados

### Servicios
- `auth.service.ts`: Métodos actualizados para usar Supabase OAuth
  - ❌ Eliminado: `initializeGoogleSignIn()`
  - ❌ Eliminado: `handleCredentialResponse()`
  - ✅ Agregado: `signInWithGoogle()`
  - ✅ Agregado: `handleAuthCallback()`
  - ✅ Actualizado: `restoreUser()` para restaurar sesión de Supabase

- `supabase.service.ts`:
  - ❌ Eliminado: `signInWithGoogleIdToken()`

### Componentes
- `signin-form.component.ts`: Simplificado para usar el nuevo método
  - ❌ Eliminado: `ngAfterViewInit()`, `waitForGoogleScript()`, `handleCredentialResponse()`
  - ✅ Agregado: `signInWithGoogle()`

- `signin-form.component.html`: Botón personalizado en lugar del botón de Google
  - ❌ Eliminado: `<div id="google-signin-button">`
  - ✅ Agregado: Botón personalizado con SVG de Google

- `auth-callback.component.ts`: Nuevo componente para manejar el callback OAuth
  - ✅ Creado: Componente que procesa el callback de autenticación

### Rutas
- `app.routes.ts`: Agregada ruta para el callback
  - ✅ Agregado: Ruta `/auth/callback`

### HTML
- `index.html`:
  - ❌ Eliminado: `<script src="https://accounts.google.com/gsi/client">`

## Testing

### Desarrollo Local

1. Asegúrate de tener configurado el entorno de desarrollo:
```typescript
// environment.development.ts
export const environment = {
  production: false,
  supabaseUrl: 'https://TU_PROYECTO.supabase.co',
  supabaseKey: 'TU_ANON_KEY'
};
```

2. Inicia el servidor de desarrollo:
```bash
ng serve
```

3. Navega a `http://localhost:4200/signin`
4. Haz clic en "Continuar con Google"
5. Verifica que la redirección funcione correctamente

### Producción

1. Asegúrate de configurar las variables de entorno correctamente
2. Actualiza las URLs de redirección en Google Cloud Console y Supabase
3. Despliega la aplicación
4. Prueba el flujo completo de autenticación

## Solución de Problemas

### Error: "redirect_uri_mismatch"
- Verifica que la URL de callback esté correctamente configurada en Google Cloud Console
- Asegúrate de que coincida exactamente con la URL de callback de Supabase

### Error: "Invalid provider"
- Verifica que Google OAuth esté habilitado en Supabase Dashboard
- Confirma que las credenciales (Client ID y Secret) estén correctamente configuradas

### La sesión no persiste después de recargar
- Verifica que `persistSession: true` esté configurado en SupabaseService
- Comprueba que la aplicación se ejecute en un navegador (no SSR durante la autenticación)

### El usuario no se redirige después de autenticarse
- Verifica que la ruta `/auth/callback` esté correctamente configurada
- Comprueba los logs del navegador para ver si hay errores en `AuthCallbackComponent`

## Notas de Seguridad

1. **Nunca expongas el Client Secret**: Mantén esta credencial segura y no la incluyas en el código del frontend
2. **Usa HTTPS en producción**: Las URLs de callback deben usar HTTPS
3. **Configura las políticas RLS**: Asegúrate de que las tablas de la base de datos tengan las políticas RLS correctas
4. **Revisa los logs**: Monitorea los logs de autenticación en Supabase Dashboard

## Referencias

- [Documentación de Supabase Auth](https://supabase.com/docs/guides/auth)
- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)
- [Row Level Security en Supabase](https://supabase.com/docs/guides/auth/row-level-security)
